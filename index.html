<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrumen IKL SPPG Interaktif</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Pustaka html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Konfigurasi Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Mengaktifkan mode gelap berbasis kelas
            theme: {
                extend: {
                    colors: {
                        'kitchen-main': '#779D89',
                        'kitchen-dark': '#457A57',
                        'kitchen-accent': '#C76E57',
                        'kitchen-cream': '#FBFBF9',
                        'score-red': '#cc3333',
                        'score-green': '#457A57',
                        
                        // Warna khusus Dark Mode
                        'dark-bg': '#121212',       /* Deep dark mode background */
                        'dark-surface': '#212121',  /* Latar elemen/kartu gelap */
                        'dark-border': '#4a5568',   /* Border abu-abu */
                        'dark-text': '#e2e8f0',     /* Teks terang */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base body background subtle Material contrast */
        body {
            background-color: #f1f3f4; /* Light surface background */
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #121212; /* Deep dark mode background */
            color: #e2e8f0;
        }

        /* --- ANIMASI GLOBAL DAN INTERAKSI MATERIAL YOU --- */
        /* General transition for smooth UI changes */
        * {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }
        
        /* Button Press Effect (Material Ripple-like) */
        button {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, filter; /* Optimization */
        }
        button:active:not(#score-toggle-btn) {
            transform: scale(0.98); 
            filter: brightness(0.9);
        }

        /* Collapsible Content Animation (max-height) */
        .collapsible-content {
            transition: max-height 0.4s cubic-bezier(0.2, 0, 0, 1), opacity 0.4s ease-in-out;
            overflow: hidden;
            opacity: 1;
        }
        .collapsible-content.collapsed {
            max-height: 0 !important; 
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Update main content container for elevated card look */
        .app-container {
            @apply shadow-xl rounded-3xl overflow-hidden; 
        }

        /* Update section cards for elevation */
        section {
            @apply shadow-lg rounded-2xl;
        }
        
        /* --- STYLING MODE GELAP & TERANG --- */
        
        /* Custom Radio Colors */
        .radio-ya { accent-color: #457A57; }
        .radio-tidak { accent-color: #cc3333; }

        /* Styling Score Label */
        .score-input:checked + .score-label {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
            border-color: #457A57;
        }
        
        /* Default Label Style (Light Mode) */
        .score-label {
            transition: all 0.15s ease-in-out;
            cursor: pointer;
            /* Ukuran font disesuaikan agar pas di kolom sempit */
            @apply border border-gray-300 w-full text-center py-1 rounded-lg text-xs font-medium hover:bg-kitchen-cream text-gray-700; 
        }

        /* Dark Mode Label Style */
        .dark .score-label {
            @apply border-gray-600 text-gray-300 hover:bg-gray-700 bg-gray-800;
        }
        
        /* Styling Special Requirement Label (Consistent with score-label) */
        .special-req-label {
            transition: all 0.15s ease-in-out;
            cursor: pointer;
            flex-grow: 1; /* Make 'Ya' and 'Tidak' equally wide */
            text-align: center;
            /* Inherit base styling from score-label concept, text-sm for better visibility */
            @apply border border-gray-300 py-1 px-2 rounded-lg font-medium hover:bg-kitchen-cream text-gray-700;
        }

        /* Dark Mode Label Style for Special Req */
        .dark .special-req-label {
            @apply border-gray-600 text-gray-300 hover:bg-gray-700 bg-gray-800;
        }

        /* Hover Rows */
        .criteria-row:hover { background-color: #FBFBF9; }
        .dark .criteria-row:hover { background-color: #2d3748; }
        
        /* Sticky Elements */
        .fixed-header { position: sticky; top: 0; z-index: 10; }
        
        /* Fixed Score Bar - Material Bottom App Bar/Prominent Bar */
        #fixed-score-bar {
            /* Hanya menyisakan bayangan (KEPT) */
            box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            background-color: #FBFBF9; /* Light surface color */
            
            /* Hapus border atas dan sudut membulat */
            border-top: none; 
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 20;
            backdrop-filter: blur(5px);
            transition: height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }

        /* Dark Mode Score Bar */
        .dark #fixed-score-bar {
            background-color: #212121; /* Darker surface in dark mode */
            color: #e2e8f0;
        }

        /* FAB Toggle Button (Right Aligned Action Button) */
        #score-toggle-btn {
            /* FAB appearance: larger, right aligned, highly elevated, circular */
            position: absolute;
            top: -32px; /* Pull it up higher */
            right: 24px; /* Position from the right edge, matching p-6 padding */
            left: auto; /* Remove left positioning */
            transform: none; /* Remove centering translation */
            width: 64px; /* Typical FAB size */
            height: 64px;
            padding: 0;
            border-radius: 50%;
            z-index: 30; /* Ensure it's above everything */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* Stronger shadow for FAB */
            @apply bg-kitchen-accent hover:bg-kitchen-accent/80 transition-transform duration-100 ease-in-out; 
            /* Ganti warna FAB agar lebih menonjol */
            background-color: #C76E57; /* kitchen-accent */
        }
        #score-toggle-btn:active {
            transform: scale(0.9); /* Simulating press/ripple effect */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        
        /* Input Material Style (Diperbarui untuk memenuhi permintaan user) */
        .autosave-input {
            /* Remove box shadow and ensure flat top corners */
            box-shadow: none !important;
            border-radius: 0 !important; 
            outline: none !important;
            
            /* Override any existing border to just show the bottom line */
            border: none !important;
            border-bottom: 1px solid #9ca3af !important; /* Base border color (gray-400) */
            
            /* Apply Tailwind classes for structure and coloring */
            @apply mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white bg-gray-100 dark:bg-gray-700;
            transition: border-bottom-color 0.2s, background-color 0.2s;
        }
        .autosave-input:focus {
            /* Focus style: Thick RED bottom border, NO ring, NO shadow */
            border-bottom: 2px solid #cc3333 !important; /* Focus border color (score-red) */
            @apply ring-0 shadow-none; 
        }


        /* Collapse/Expand Transition for Sections */
        .section-header {
            cursor: pointer;
            user-select: none;
        }
        .section-header:hover {
            opacity: 0.8;
        }

        /* Styling for the new collapsible criteria headers */
        .criteria-header-row {
            cursor: pointer;
        }

        /* PERBAIKAN B. Penilaian IKL untuk Responsif */
        
        /* MOBILE VIEW (default, < md): Sembunyikan tabel, tampilkan card list */
        #inspection-table { 
            display: none; 
        }
        #inspection-cards { 
            display: block; 
        }
        
        /* DESKTOP VIEW (>= md): Tampilkan tabel, sembunyikan card list */
        @media (min-width: 768px) { /* md: breakpoint in Tailwind */
            #inspection-table {
                display: table;
            }
            #inspection-cards {
                display: none;
            }
        }

        /* Print Media Queries */
        @media print {
            #fixed-score-bar, #export-btn-container, .no-print, #theme-toggle, #score-toggle-btn { display: none !important; }
            body { margin: 0; padding: 0; background-color: white !important; color: black !important; }
            .fixed-header { position: static !important; }
            /* Memaksa elemen yang tersembunyi untuk muncul */
            .criteria-group-item, #inspection-table { display: table-row !important; } 
            #inspection-cards { display: none !important; } 
            .criteria-row, #special-requirements > div, section { page-break-inside: avoid !important; }
            thead { display: table-header-group; }
            /* Paksa Light Mode saat Print Dialog Browser Native */
            .dark { color-scheme: light; } 
            
            /* Pastikan semua section terbuka saat print */
            .collapsible-content { display: block !important; }
            .section-icon { display: none !important; }
        }
        
        /* CLASSIFICATION CSS (Added for the final score color) */
        .text-ikl-green { color: #457A57; } /* score-green */
        .text-ikl-red { color: #cc3333; } /* score-red */
    </style>
</head>
<body class="p-4 md:p-8 bg-[#f7f9fb] dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div class="max-w-6xl mx-auto bg-white dark:bg-gray-800 app-container border dark:border-gray-700">
        
        <!-- Header Aplikasi -->
        <header class="bg-kitchen-dark p-6 text-white text-center relative rounded-t-3xl">
            <h1 class="text-2xl md:text-3xl font-extrabold mb-1">INSTRUMEN INSPEKSI KESEHATAN LINGKUNGAN (IKL)</h1>
            <h2 class="text-lg md:text-xl font-medium">SATUAN PELAYANAN PEMENUHAN GIZI (SPPG)</h2>
            <div id="autosave-status" class="mt-2 text-xs font-light italic opacity-80 h-4"></div>

            <!-- Tombol Toggle Tema (Pojok Kanan Atas) -->
            <button id="theme-toggle" class="absolute top-4 right-4 p-2 rounded-full bg-white/20 hover:bg-white/30 transition-colors focus:outline-none" title="Ganti Tema">
                <!-- Icon Matahari (untuk mode gelap) -->
                <svg id="icon-sun" class="w-6 h-6 text-yellow-300 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Icon Bulan (untuk mode terang) -->
                <svg id="icon-moon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <main class="p-6 md:p-8" id="form-content">
            <!-- Bagian A: Data Umum SPPG (Collapsible) -->
            <section class="mb-8 p-4 bg-kitchen-cream dark:bg-gray-700 rounded-lg border border-kitchen-main/50 dark:border-gray-600">
                <div class="flex justify-between items-center section-header border-b border-kitchen-accent/50 pb-2 mb-4" onclick="toggleSection('content-a')">
                    <h3 class="text-lg font-bold text-gray-700 dark:text-white">A. Data Umum</h3>
                    <!-- Ikon Panah Bawah/Atas -->
                    <!-- Ikon default (Expanded/Terbuka) harus menunjuk KE BAWAH, jadi tambahkan rotate-180 -->
                    <svg id="icon-content-a" class="w-6 h-6 text-gray-500 dark:text-gray-300 transition-transform duration-200 section-icon rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                
                <div id="content-a" class="collapsible-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Input fields dengan styling dark mode -->
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">1. Nama SPPG</span>
                            <input type="text" id="nama_sppg" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white">
                        </label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">2. Alamat</span><input type="text" id="alamat_sppg" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">3. Nama Pengelola</span><input type="text" id="nama_pengelola" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">4. Kontak Pengelola</span><input type="text" id="kontak_pengelola" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">5. Jumlah Porsi</span><input type="number" id="jumlah_porsi" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">6. Distribusi Pangan</span><input type="text" id="distribusi_pangan" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">7. Jumlah Total Penjamah Pangan</span><input type="number" id="total_penjamah" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">8. Jumlah Penjamah Pangan Terlatih</span><input type="number" id="penjamah_bersertifikat" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">9. Nama Pemeriksa</span><input type="text" id="nama_pemeriksa" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>
                        <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">10. Tanggal Pemeriksaan</span><input type="date" id="tanggal_pemeriksaan" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></label>

                        <div class="col-span-1 md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-kitchen-main/30 dark:border-gray-500 pt-4 mt-4">
                            <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">Lintang (Latitude)</span><input type="text" id="latitude" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white" placeholder="-6.2088" readonly></label>
                            <label class="block"><span class="text-sm font-medium text-gray-700 dark:text-gray-300">Bujur (Longitude)</span><input type="text" id="longitude" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white" placeholder="106.8456" readonly></label>
                            <!-- Tombol Dapatkan Lokasi -->
                            <button id="get-location-btn" class="mt-6 md:mt-1 flex items-center justify-center bg-kitchen-dark hover:bg-kitchen-dark/80 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md text-sm">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9a2 2 0 100-4 2 2 0 000 4z"/></svg>
                                Dapatkan Lokasi
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bagian B: Inspeksi Kesehatan Lingkungan (Collapsible) -->
            <section class="mb-8">
                <div class="flex justify-between items-center section-header border-b border-gray-300 dark:border-gray-600 pb-2 mb-4" onclick="toggleSection('content-b')">
                    <h3 class="text-lg font-bold text-gray-700 dark:text-white">B. Penilaian IKL</h3>
                    <!-- Ikon default (Expanded/Terbuka) harus menunjuk KE BAWAH, jadi tambahkan rotate-180 -->
                    <svg id="icon-content-b" class="w-6 h-6 text-gray-500 dark:text-gray-300 transition-transform duration-200 section-icon rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                
                <div id="content-b" class="collapsible-content">
                    <!-- Keterangan Nilai (Diperbarui) -->
                    <div class="mb-4 p-4 bg-kitchen-main/20 dark:bg-green-900/30 text-kitchen-dark dark:text-green-300 rounded-lg border border-kitchen-dark/50 dark:border-green-700 shadow-md">
                        <p class="font-bold text-sm">Keterangan Nilai:</p> 
                        <p class="text-xs"><span class="font-bold">NA</span> = Not Applicable (tidak berlaku)</p>
                        <p class="text-xs"><span class="font-bold">1</span> = Minor (perlu perbaikan wajar)</p>
                        <p class="text-xs"><span class="font-bold">2</span> = Mayor (perlu perhatian serius)</p>
                        <p class="text-xs"><span class="font-bold">3</span> = Kritis (risiko kesehatan tinggi, perlu perbaikan segera)</p>
                    </div>
                    
                    <!-- Keterangan Area - Disesuaikan untuk Responsif (Legenda Area UTUH) -->
                    <div id="area-legend" class="mb-4 text-xs font-medium text-gray-600 dark:text-gray-300 grid grid-cols-2 md:grid-cols-4 gap-2 p-3 bg-kitchen-cream dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 shadow-sm">
                        <p><span class="font-bold">A</span> = Area luar bangunan</p>
                        <p><span class="font-bold">B</span> = Area fasilitas karyawan</p>
                        <p><span class="font-bold">C</span> = Area penerimaan bahan baku</p>
                        <p><span class="font-bold">D</span> = Area penyimpanan</p>
                        <p><span class="font-bold">E</span> = Area pengolahan pangan</p>
                        <p><span class="font-bold">F</span> = Area pengemasan/pemorsian</p>
                        <p><span class="font-bold">G</span> = Area loading produk jadi</p>
                        <p><span class="font-bold">H</span> = Area pencucian peralatan</p>
                    </div>

                    <!-- 1. Tampilan Desktop (Tabel Horizontal) - Hanya terlihat di md: ke atas -->
                    <div class="overflow-x-auto">
                        <table id="inspection-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600 rounded-lg overflow-hidden shadow-md">
                            <thead class="bg-kitchen-dark text-white fixed-header">
                                <tr>
                                    <th class="w-10 px-2 py-3 text-xs font-bold uppercase tracking-wider text-center align-middle">Nomor</th>
                                    <th class="w-64 px-4 py-3 text-xs font-bold uppercase tracking-wider text-center align-middle">Persyaratan</th>
                                    <th colspan="8" class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Penilaian</th>
                                </tr>
                                <tr class="bg-kitchen-dark/80">
                                    <th colspan="2" class="px-4 py-1 text-xs"></th>
                                    <th class="px-2 py-1 text-xs font-bold">A</th>
                                    <th class="px-2 py-1 text-xs font-bold">B</th>
                                    <th class="px-2 py-1 text-xs font-bold">C</th>
                                    <th class="px-2 py-1 text-xs font-bold">D</th>
                                    <th class="px-2 py-1 text-xs font-bold">E</th>
                                    <th class="px-2 py-1 text-xs font-bold">F</th>
                                    <th class="px-2 py-1 text-xs font-bold">G</th>
                                    <th class="px-2 py-1 text-xs font-bold">H</th>
                                </tr>
                            </thead>
                            <tbody id="inspection-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700 text-gray-800 dark:text-gray-200">
                                <!-- Kriteria akan dimasukkan di sini oleh JavaScript (Tabel) -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 2. Tampilan Mobile (Daftar Kartu Vertikal) - Hanya terlihat di bawah md: -->
                    <div id="inspection-cards" class="space-y-3">
                        <!-- Kriteria akan dimasukkan di sini oleh JavaScript (Kartu) -->
                    </div>
                </div>
            </section>
            
            <!-- Bagian D: Persyaratan Khusus (Collapsible) -->
            <section class="mt-8 p-4 bg-kitchen-cream dark:bg-gray-700 rounded-lg border border-kitchen-main/50 dark:border-gray-600">
                <div class="flex justify-between items-center section-header border-b border-kitchen-accent/50 pb-2 mb-4" onclick="toggleSection('content-d')">
                    <h3 class="text-lg font-bold text-gray-700 dark:text-white">D. Persyaratan Khusus</h3>
                    <!-- Ikon default (Collapsed/Tertutup) harus menunjuk KE ATAS, jadi hapus rotate-180 -->
                    <svg id="icon-content-d" class="w-6 h-6 text-gray-500 dark:text-gray-300 transition-transform duration-200 section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>

                <div id="content-d" class="collapsible-content collapsed">
                    <div id="special-requirements" class="space-y-3">
                        <!-- Persyaratan khusus akan dimasukkan di sini oleh JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Bagian E: Catatan Akhir dan Tanda Tangan (Collapsible) -->
            <section class="mt-8 p-4 bg-kitchen-cream dark:bg-gray-700 rounded-lg border border-kitchen-main/50 dark:border-gray-600">
                <div class="flex justify-between items-center section-header border-b border-kitchen-accent/50 pb-2 mb-4" onclick="toggleSection('content-e')">
                    <h3 class="text-lg font-bold text-gray-700 dark:text-white">E. Catatan dan Saran</h3>
                    <!-- Ikon default (Collapsed/Tertutup) harus menunjuk KE ATAS, jadi hapus rotate-180 -->
                    <svg id="icon-content-e" class="w-6 h-6 text-gray-500 dark:text-gray-300 transition-transform duration-200 section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>

                <div id="content-e" class="collapsible-content collapsed">
                    <label class="block mb-4">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-300">Catatan dan saran</span>
                        <textarea id="catatan_akhir" rows="4" class="autosave-input mt-1 block w-full p-2 text-sm text-gray-700 dark:text-white"></textarea>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="font-semibold text-gray-700 dark:text-gray-300 mb-2 text-sm">Petugas Pemeriksa</p>
                            <input type="text" placeholder="" class="autosave-input block w-full p-2 mb-4 text-sm text-gray-700 dark:text-white" id="ttd_pemeriksa_nama">
                            <div class="border-b border-dashed border-gray-400 pt-12"><span class="text-xs text-gray-500 dark:text-gray-400">Tanda tangan</span></div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 dark:text-gray-300 mb-2 text-sm">Pengelola SPPG</p>
                            <input type="text" placeholder="" class="autosave-input block w-full p-2 mb-4 text-sm text-gray-700 dark:text-white" id="ttd_pengelola_nama">
                            <div class="border-b border-dashed border-gray-400 pt-12"><span class="text-xs text-gray-500 dark:text-gray-400">Tanda tangan</span></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Bagian F: Analisis dan Rekomendasi Berbasis Gemini AI (Collapsible) -->
            <section class="mt-8 p-4 bg-kitchen-cream dark:bg-gray-700 rounded-lg border border-kitchen-main/50 dark:border-gray-600">
                <div class="flex justify-between items-center section-header border-b border-kitchen-accent/50 pb-2 mb-4" onclick="toggleSection('content-f')">
                    <h3 class="text-lg font-bold text-gray-700 dark:text-white flex items-center">F. Rekomendasi</h3>
                    <!-- Ikon default (Collapsed/Tertutup) harus menunjuk KE ATAS, jadi hapus rotate-180 -->
                    <svg id="icon-content-f" class="w-6 h-6 text-gray-500 dark:text-gray-300 transition-transform duration-200 section-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>

                <div id="content-f" class="collapsible-content collapsed">
                    <div class="mb-4">
                        <button id="generate-ai-report-btn" class="flex items-center justify-center bg-kitchen-accent hover:bg-kitchen-accent/90 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg text-base w-full md:w-auto">
                            Buat Rekomendasi Menggunakan AI
                        </button>
                    </div>
                    
                    <div id="ai-report-output" class="min-h-[100px] p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-xl text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap shadow-inner">
                        Tekan tombol di atas untuk menghasilkan ringkasan temuan kritis dan langkah perbaikan yang direkomendasikan oleh Gemini AI.
                    </div>
                    <div id="ai-loading" class="hidden mt-2 text-center text-sm font-medium text-kitchen-dark dark:text-green-400">
                        <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Gemini AI sedang menganalisis data...
                    </div>
                    <div id="ai-error" class="hidden mt-2 p-3 bg-score-red/20 text-score-red dark:text-red-300 rounded-md text-sm font-medium">
                        Terjadi kesalahan saat menghubungi Gemini AI. Coba lagi atau periksa koneksi internet Anda.
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Bagian C: Total Skor dan Hasil (Fixed/Sticky Bottom - Material Bottom App Bar) -->
    <div id="fixed-score-bar" class="p-4 md:p-6">
        
        <!-- FAB Toggle Button (Central Action Button) -->
        <button id="score-toggle-btn" onclick="toggleScoreBar()" class="text-white flex items-center justify-center">
            <!-- Icon Panah (Stroke width 3 untuk tampilan yang lebih tebal dan Material-like) -->
            <!-- Diberi rotate-180 agar default (visible) menjadi panah ke bawah -->
            <svg id="score-toggle-icon" class="w-8 h-8 transition-transform duration-300 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"></path>
            </svg>
        </button>

        <div id="score-content" class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4 transition-all duration-300 ease-in-out">
            
            <!-- Tombol Aksi (Kiri/Bawah pada mobile) -->
            <!-- PERUBAHAN: Menggunakan flex-row dan justify-between pada mobile dan mengatur lebar 1/2 untuk tombol -->
            <div class="flex flex-row justify-between gap-2 w-full md:w-auto order-3 md:order-1">
                <button id="reset-form-btn" class="flex-shrink-0 flex items-center justify-center bg-score-red hover:bg-score-red/90 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-md whitespace-nowrap w-1/2 md:w-auto text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Reset
                </button>
                <button id="export-pdf-btn" class="flex-shrink-0 flex items-center justify-center bg-kitchen-dark hover:bg-kitchen-dark/80 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg whitespace-nowrap w-1/2 md:w-auto text-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Unduh
                </button>
            </div>

            <!-- Score Progress -->
            <div class="flex-grow w-full md:w-auto order-1 md:order-2">
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-2">C. Nilai IKL</h3>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                    <div id="score-progress-bar" class="h-4 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
                <!-- Hilangkan tulisan (Sangat Buruk) dan (Sempurna) -->
                <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-1">
                    <span>0%</span> 
                    <span>100%</span>
                </div>
            </div>
            
            <!-- Nilai Skor -->
            <div class="flex-shrink-0 flex space-x-4 items-center order-2 md:order-3">
                <div class="text-center">
                    <!-- Ganti Total Ketidaksesuaian dengan Tidak Memenuhi Syarat -->
                    <p class="text-xs text-gray-500 dark:text-gray-400">Tidak Memenuhi Syarat</p>
                    <p id="total-score-value" class="text-xl font-bold text-score-red mt-1">0</p>
                    <!-- Ganti Max: 507 dengan Maksimum 507 -->
                    <p id="max-score-label" class="text-xs text-gray-500 dark:text-gray-400">Maksimum: -</p>
                </div>
                <div class="text-center">
                    <!-- Ganti Skor IKL (0-100) dengan Nilai Final IKL -->
                    <p class="text-sm font-semibold text-gray-800 dark:text-gray-200">Nilai Final IKL</p> 
                    <!-- Tambahkan kelas warna awal (default) di sini, akan ditimpa oleh JS -->
                    <p id="final-ikl-score" class="text-4xl font-extrabold transition-colors duration-500 text-ikl-green">100.00</p>
                    <p id="ikl-status" class="text-xs font-semibold mt-1"></p> 
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- DATA KONSTAN FORMULIR ---
        const CRITERIA = [
            { no: 1, text: "Halaman SPPG dalam kondisi bersih, tidak bersemak, dan tidak terdapat tanaman yang menempel langsung pada dinding bangunan pengolahan pangan.", areas: { A: 1, B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' } },
            { no: 2, text: "Area parkir kendaraan jauh dari pintu masuk bangunan pengolahan pangan untuk mencegah kontaminasi asap kendaraan masuk ke ruang pengolahan pangan.", areas: { A: 1, B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' } },
            { no: 3, text: "Bangunan SPPG dilengkapi dengan drainase pada bagian luar dengan kondisi bersih, tidak tersumbat atau meluap, dan memiliki grease trap/penangkap lemak.", areas: { A: 1, B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' } },
            { no: 4, text: "Pintu masuk bahan pangan dan produk jadi dibuat secara terpisah", areas: { A: 1, B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' } },
            { no: 5, text: "Area bebas banjir, jika tidak, maka terdapat pengendalian untuk mencegah kontaminasi terhadap pangan yang sedang ditangani", areas: { A: 2, B: 3, C: 3, D: 3, E: 3, F: 3, G: 3, H: 3 } },
            
            // NO 6 FIXED: F and G set to 2, H set to 1, A set to 1, C set to 1, D set to 2, E set to 2
            { no: 6, text: "Area bebas dari polusi (contoh: pencemaran bau/asap/debu), dan jika tidak, maka terdapat pengendalian untuk mencegah kontaminasi terhadap pangan yang ditangani.", areas: { A: 1, B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 1 } },
            
            { no: 7, text: "Bangunan / area memiliki ventilasi udara yang cukup.", areas: { A: 1, B: 1, C: 1, D: 1, E: 1, F: 1, G: 1, H: 1 } },
            
            // HEADER FOR GROUP 8 (Collapsible)
            { no: '8', text: "Tempat penyimpanan atau loker karyawan", isHeader: true, group: '8' },
            { no: '8a', text: "Tersedia ruang/area khusus untuk istirahat karyawan yang bersih dan bebas dari vektor atau binatang pembawa penyakit (semua siklus kehidupan) dan tanda-tanda keberadaannya.", areas: { A: 'NA', B: 1, C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'a', group: '8' },
            { no: '8b', text: "Tersedia area penyimpanan pakaian dan barang pribadi karyawan (loker) yang bersih dan cukup (pria dan wanita).", areas: { A: 'NA', B: 1, C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'b', group: '8' },
            { no: '8c', text: "Tempat penyimpanan (loker) dilengkapi dengan tata tertib penggunaan loker dan tidak digunakan sebagai tempat penyimpanan makanan dan peralatan pengolahan pangan", areas: { A: 'NA', B: 1, C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'c', group: '8' },

            // HEADER FOR GROUP 9 (Collapsible)
            { no: '9', text: "Toilet", isHeader: true, group: '9' },
            { no: '9a', text: "Jumlah toilet cukup sesuai jumlah karyawan dan dibuat terpisah antara laki-laki dan perempuan", areas: { A: 'NA', B: 1, C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'a', group: '9' },
            { no: '9b', text: "Desain toilet kuat dengan permukaan halus dan mudah dibersihkan", areas: { A: 'NA', B: 2, C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'b', group: '9' },
            { no: '9c', text: "Pintu atau ventilasi toilet tidak membuka langsung ke area pengolahan pangan", areas: { A: 'NA', B: 2, C: 2, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'c', group: '9' },
            { no: '9d', text: "Toilet dilengkapi dengan sabun, air mengalir, alat pengering tangan, tempat sampah, dan petunjuk mencuci tangan setelah dari toilet.", areas: { A: 'NA', B: 3, C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'd', group: '9' },

            // HEADER FOR GROUP 10 (Collapsible)
            { no: '10', text: "Wastafel atau fasilitas cuci tangan", isHeader: true, group: '10' },
            { no: '10a', text: "Jumlah wastafel/fasilitas cuci tangan cukup sesuai dengan jumlah karyawan dan posisi tempat cuci tangan mudah dijangkau di area dimana banyak kontak tangan penjamah dengan pangan", areas: { A: 'NA', B: 2, C: 2, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'a', group: '10' },
            { no: '10b', text: "Desain kuat, mudah dibersihkan, dan dilengkapi dengan petunjuk cuci tangan", areas: { A: 'NA', B: 1, C: 1, D: 1, E: 1, F: 1, G: 1, H: 1 }, displayNo: 'b', group: '10' },
            { no: '10c', text: "Dilengkapi dengan air mengalir, sabun cuci tangan, dan pengering tangan (bisa hand dryer atau tissue, tetapi tidak boleh kain serbet)", areas: { A: 'NA', B: 3, C: 3, D: 3, E: 3, F: 3, G: 3, H: 3 }, displayNo: 'c', group: '10' },
            
            // NO 11
            { no: 11, text: "Luas area cukup untuk memudahkan pergerakan bahan atau personil", areas: { A: 'NA', B: 1, C: 1, D: 1, E: 1, F: 1, G: 1, H: 1 } },
            
            // NO 12
            { no: 12, text: "Struktur bangunan (dinding, plafon, atau atap) tidak ada lubang / retakan yang menjadi potensi masuknya atau bersarangnya vektor atau binatang pembawa penyakit.", areas: { A: 1, B: 1, C: 1, D: 2, E: 2, F: 2, G: 1, H: 1 } },
            
            // HEADER FOR GROUP 13
            { no: '13', text: "Lantai", isHeader: true, group: '13' },
            { no: '13a', text: "Lantai bersih dan terawat (tidak rusak atau tidak retak/berlubang)", areas: { A: 'NA', B: 1, C: 1, D: 1, E: 2, F: 2, G: 1, H: 1 }, displayNo: 'a', group: '13' },
            { no: '13b', text: "Tidak terdapat genangan air", areas: { A: 1, B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'b', group: '13' },
            { no: '13c', text: "Pertemuan lantai dan dinding tidak membentuk sudut mati (jika tidak demikian, maka harus dilakukan pembersihan secara rutin dan tidak ditemukan bukti visual kumpulan debu/kotoran)", areas: { A: 'NA', B: 1, C: 1, D: 1, E: 1, F: 1, G: 1, H: 1 }, displayNo: 'c', group: '13' },
            
            { no: 14, text: "Pintu dalam kondisi bersih dan terawat (tidak berlubang dan dapat menutup sempurna)", areas: { A: 'NA', B: 1, C: 1, D: 1, E: 1, F: 1, G: 1, H: 1 } },
            
            { no: 15, text: "Pencahayaan cukup terang dengan lampu tercover (jika lampu terbuat dari bahan mudah pecah) dan kondisi cover (jika ada) bersih dan terawat.", areas: { A: 'NA', B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 2 } },
            
            // HEADER FOR GROUP 16
            { no: '16', text: "Langit-langit", isHeader: true, group: '16' },
            { no: '16a', text: "Tinggi minimal 2.4 meter dari lantai", areas: { A: 'NA', B: 1, C: 1, D: 1, E: 1, F: 1, G: 1, H: 1 }, displayNo: 'a', group: '16' },
            { no: '16b', text: "Kondisi tertutup, bersih dan terawat (contoh: tidak ada jamur, debu, kotoran, sarang hama atau sawang)", areas: { A: 'NA', B: 1, C: 2, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'b', group: '16' },
            { no: '16c', text: "Tidak ada kondensasi air", areas: { A: 'NA', B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 1 }, displayNo: 'c', group: '16' },
            
            // HEADER FOR GROUP 17
            { no: '17', text: "Tempat sampah dan limbah", isHeader: true, group: '17' },
            { no: '17a', text: "Tidak ada sampah berserakan", areas: { A: 1, B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'a', group: '17' },
            { no: '17b', text: "Terdapat tempat sampah dalam kondisi tertutup, sampah tidak mengunung (frekuensi pembuangan minimal 1x24 jam) dan kondisi bersih", areas: { A: 1, B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'b', group: '17' },
            
            // HEADER FOR GROUP 18
            { no: '18', text: "Vektor atau binatang pembawa penyakit", isHeader: true, group: '18' },
            { no: '18a', text: "Bebas vektor atau binatang pembawa penyakit (semua tingkat siklus kehidupannya) dan tanda-tanda keberadaannya (contoh: kotoran atau bagian tubuh hama)", areas: { A: 1, B: 1, C: 2, D: 3, E: 3, F: 3, G: 3, H: 2 }, displayNo: 'a', group: '18' },
            { no: '18b', text: "Terdapat jebakan hama yang ditempatkan pada posisi yang sesuai dan dalam kondisi terawat (tidak rusak, tidak berjamur, dan bersih).", areas: { A: 1, B: 1, C: 2, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'b', group: '18' },
            { no: '18c', text: "Pengendalian tidak mengunakan bahan kimia (pestisida) di area dalam bangunan pengolahan pangan", areas: { A: 'NA', B: 1, C: 3, D: 3, E: 3, F: 3, G: 3, H: 3 }, displayNo: 'c', group: '18' },
            { no: '18d', text: "JIKA ventilasi berupa bukaan (contoh: jendela/exhaust) yang terbuka keluar, maka terdapat kasa/tirai/plastik curtain anti serangga untuk mencegah masuknya vektor atau binatang pembawa penyakit. Kasa/tirai/plastik curtain dalam kondisi bersih dan terawat.", areas: { A: 1, B: 1, C: 2, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'd', group: '18' },
            
            // HEADER FOR GROUP 19 (Diubah agar satu baris)
            { no: '19', text: "Penyimpanan Bahan & Pangan Matang", isHeader: true, group: '19' },
            { no: '19a', text: "Penyimpanan bahan baku, ingredien dan kemasan tidak langsung menyentuh lantai (contoh: menggunakan palet) dengan jarak minimal 15 cm dari lantai, 5 cm dari dinding, dan 60 cm dari langit-langit", areas: { A: 'NA', B: 1, C: 'NA', D: 1, E: 1, F: 1, G: 1, H: 'NA' }, displayNo: 'a', group: '19' },
            { no: '19b', text: "Kemasan bekas bahan baku mentah tidak disimpan di area yang terdapat pangan matang", areas: { A: 'NA', B: 'NA', C: 'NA', D: 'NA', E: 2, F: 2, G: 2, H: 'NA' }, displayNo: 'b', group: '19' },
            { no: '19c', text: "Penyimpanan bahan mentah tidak menyatu dengan pangan matang (contoh di ruang penyimpanan, chiller atau freezer), dan penyimpanan bahan pangan (mentah atau matang) tidak menyatu dengan penyimpanan bahan kimia.", areas: { A: 'NA', B: 'NA', C: 3, D: 3, E: 3, F: 3, G: 3, H: 'NA' }, displayNo: 'c', group: '19' },
            { no: '19d', text: "Bahan baku pangan dan ingredient dalam kondisi baik dan tidak busuk atau berlendir", areas: { A: 'NA', B: 'NA', C: 3, D: 3, E: 3, F: 3, G: 3, H: 'NA' }, displayNo: 'd', group: '19' },
            { no: '19e', text: "Khusus untuk bahan baku olahan terkemas dalam kondisi baik (tidak kedaluwarsa, kemasan utuh/tidak bocor, dan memiliki izin edar dari instansi terkait)", areas: { A: 'NA', B: 'NA', C: 3, D: 3, E: 3, F: 3, G: 3, H: 'NA' }, displayNo: 'e', group: '19' },
            { no: '19f', text: "Khusus untuk chiller atau freezer yang digunakan untuk menyimpan bahan pangan, ingredien, atau pangan siap saji, maka suhu penyimpanan harus sesuai (chiller 0-4°C dan freezer ≤(-15°C))", areas: { A: 'NA', B: 'NA', C: 'NA', D: 2, E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'f', group: '19' },
            { no: '19g', text: "Bahan kimia (contoh untuk cuci tangan/sanitasi tangan, cuci peralatan, pembersihan lantai) disimpan pada area khusus dengan akses terbatas dan memiliki identitas yang jelas. Kuantitas bahan kimia yang digunakan di setiap area hanya untuk penggunaan harian (tidak dalam kemasan galon/bulk)", areas: { A: 'NA', B: 1, C: 1, D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'g', group: '19' },
            { no: '19h', text: "Tidak ada pangan matang yang disimpan sementara di area luar bangunan pengolahan dalam kondisi terbuka.", areas: { A: 3, B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'h', group: '19' },
            { no: '19i', text: "Penyimpanan kemasan yang kontak pangan matang dalam kondisi bersih", areas: { A: 'NA', B: 'NA', C: 'NA', D: 3, E: 3, F: 3, G: 3, H: 3 }, displayNo: 'i', group: '19' },
            
            // HEADER FOR GROUP 20
            { no: '20', text: "Personil", isHeader: true, group: '20' },
            { no: '20a', text: "Personil sehat/tidak menunjukkan gejala penyakit", areas: { A: 'NA', B: 'NA', C: 1, D: 3, E: 3, F: 3, G: 3, H: 3 }, displayNo: 'a', group: '20' },
            { no: '20b', text: "Personil menggunakan APD (celemek, masker, hairnet/penutup rambut) dengan lengkap dan benar", areas: { A: 'NA', B: 'NA', C: 'NA', D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'b', group: '20' },
            { no: '20c', text: "Personil menggunakan pakaian kerja khusus selama berada di area pengolahan pangan", areas: { A: 'NA', B: 'NA', C: 'NA', D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'c', group: '20' },
            { no: '20d', text: "Personil menerapkan personil higiene dengan benar (contoh: tidak memakai aksesoris/perhiasan, rutin mencuci tangan, tidak batuk/bersin langsung di atas pangan, tidak merokok/makan/minum saat mengolah pangan, tidak mengaruk atau menyentuh bagian badan dan kemudian menyentuh pangan)", areas: { A: 'NA', B: 'NA', C: 'NA', D: 3, E: 3, F: 3, G: 3, H: 2 }, displayNo: 'd', group: '20' },
            { no: '20e', text: "Jika personil memiliki luka, maka luka harus ditutup dengan perban/sejenisnya dan ditutup penutup yang tahan air dan dalam kondisi bersih", areas: { A: 'NA', B: 'NA', C: 'NA', D: 3, E: 3, F: 3, G: 3, H: 3 }, displayNo: 'e', group: '20' },
            { no: '20f', text: "Personil yang bekerja di area ini memiliki pemahaman mengenai prinsip umum higiene personil dan keamanan pangan", areas: { A: 'NA', B: 'NA', C: 'NA', D: 2, E: 2, F: 2, G: 2, H: 2 }, displayNo: 'f', group: '20' },
            
            // HEADER FOR GROUP 21 (Diubah agar satu baris)
            { no: '21', text: "Peralatan & Kemasan Kontak Pangan", isHeader: true, group: '21' },
            { no: '21a', text: "Dibuat dari bahan tara pangan (kedap air, tahan karat, tidak mentransfer zat berbahaya) dan kondisi terawat (tidak rusak, tidak berkarat, dan bersih)", areas: { A: 'NA', B: 'NA', C: 1, D: 2, E: 3, F: 3, G: 3, H: 'NA' }, displayNo: 'a', group: '21' },
            { no: '21b', text: "Peralatan dalam kondisi terawat (tidak rusak/pecah, tidak berkarat, dan bersih)", areas: { A: 'NA', B: 'NA', C: 1, D: 2, E: 3, F: 3, G: 3, H: 1 }, displayNo: 'b', group: '21' },
            { no: '21c', text: "Khusus untuk kemasan pangan matang dalam kondisi bersih dan terawat (tidak rusak/pecah, tidak berkarat, dan bersih (tidak terdapat sisa bahan kimia pencucian atau sisa makanan), serta dapat ditutup sempurna)", areas: { A: 'NA', B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 3, G: 3, H: 'NA' }, displayNo: 'c', group: '21' },
            
            // HEADER FOR GROUP 22
            { no: '22', text: "Proses pengolahan pangan", isHeader: true, group: '22' },
            { no: '22a', text: "Jika terdapat proses thawing/pencairan bahan pangan, maka dilakukan dengan benar.", areas: { A: 'NA', B: 'NA', C: 'NA', D: 2, E: 'NA', F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'a', group: '22' },
            { no: '22b', text: "Pangan dimasak sampai matang sempurna dengan penampakan visual normal (tidak ada benda asing) dan bau normal", areas: { A: 'NA', B: 'NA', C: 'NA', D: 'NA', E: 3, F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'b', group: '22' },
            { no: '22c', text: "Suhu inti pangan yang dimasak minimal 75°C (lakukan sampling pada saat inspeksi dan ukur menggunakan termometer)", areas: { A: 'NA', B: 'NA', C: 'NA', D: 'NA', E: 3, F: 'NA', G: 'NA', H: 'NA' }, displayNo: 'c', group: '22' },
            
            // HEADER FOR GROUP 23
            { no: '23', text: "Proses pengangkutan pangan matang", isHeader: true, group: '23' },
            { no: '23a', text: "Kondisi kendaraan pengangkutan pangan matang bersih, terawat dan bebas dari vektor atau binatang pembawa penyakit.", areas: { A: 'NA', B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 2, H: 'NA' }, displayNo: 'a', group: '23' },
            { no: '23b', text: "Pangan yang diangkut dalam kondisi kemasan tertutup sempurna dan pengangkutan sesuai untuk menjaga suhu panas atau dingin (sesuai jenis pangan)", areas: { A: 'NA', B: 'NA', C: 'NA', D: 'NA', E: 'NA', F: 'NA', G: 3, H: 'NA' }, displayNo: 'b', group: '23' },
        ];

        const SPECIAL_REQUIREMENTS = [
            { no: 1, text: "Pengelola/pemilik SPPG memiliki sertifikat pelatihan keamanan pangan siap saji" },
            { no: 2, text: "Penjamah pangan yang bekerja di SPPG sudah memiliki sertifikat pelatihan keamanan pangan siap saji minimal 50%" },
            { no: 3, text: "Penjamah dilakukan pemeriksaan kesehatan secara berkala minimal 1 (satu) kali setahun dan dapat dibuktikan dengan rekaman pemeriksaan kesehatan dari unit pelayanan kesehatan setempat." },
            { no: 4, text: "Tersedia hasil analisa pengujian air dengan hasil yang sesuai dengan persyaratan air minum yang berlaku dan rekaman hasil analisa laboratorium dapat ditunjukkan (1 tahun terakhir)" },
            { no: 5, text: "Tersedia laporan hasil pemeriksaan laboratorium sampel pangan (minimal 1 kali dalam 1 tahun terakhir) sesuai dengan Standar Baku Mutu Kesehatan Lingkungan (SBMKL) yang berlaku saat ini dan hasil analisa sesuai atau masuk persyaratan yang berlaku." },
            { no: 6, text: "Tersedia dokumentasi pengawasan internal secara berkala (minimal dilakukan 6 bulan sekali) menggunakan formulir IKL dan dibuktikan dengan rekaman pengawasan internal (IKL) yang sudah terisi." },
            { no: 7, text: "SPPG sudah menerapkan penyimpanan sampel arsip (bank sample) untuk pangan yang diproduksi harian selama 2 x 24 jam pada suhu penyimpanan chiller/kulkas." },
            { no: 8, text: "Tersedia perlengkapan P3K, obat-obatan, dan APAR yang tidak kedaluwarsa dan mudah dijangkau" },
            // HEADER FOR GROUP 9 SPECIAL REQUIREMENTS (Dibuat dapat diklik)
            { no: '9', text: "Tersedia dokumentasi atau rekaman:", isHeader: true, group: '9_doc' },
            // NEW SUB-HEADER FOR 9
            { no: '9.a', text: "SPPG memiliki SOP di bawah ini (dapat ditunjukkan SOP dan rekaman daftar hadir sosialiasinya), yaitu:", isSubHeader: true, group: '9_doc' },
            { no: '9.a.1', text: "SOP sanitasi fasilitas dan ruangan", displayNo: 'a.1', group: '9_doc' },
            { no: '9.a.2', text: "SOP sanitasi peralatan", displayNo: 'a.2', group: '9_doc' },
            { no: '9.a.3', text: "SOP persiapan bahan pangan", displayNo: 'a.3', group: '9_doc' },
            { no: '9.a.4', text: "SOP pengolahan", displayNo: 'a.4', group: '9_doc' },
            { no: '9.a.5', text: "SOP penyimpanan makanan dan sampel makanan", displayNo: 'a.5', group: '9_doc' },
            { no: '9.a.6', text: "SOP keselamatan kerja", displayNo: 'a.6', group: '9_doc' },
            { no: '9.a.7', text: "SOP higiene dan pemeriksaan kesehatan personil", displayNo: 'a.7', group: '9_doc' },
            { no: '9.a.8', text: "SOP pemeliharaan peralatan dan bangunan", displayNo: 'a.8', group: '9_doc' },
            { no: '9.a.9', text: "SOP pengendalian serangga, hewan pengerat, dan hewan peliharaan", displayNo: 'a.9', group: '9_doc' },
            { no: '9.a.10', text: "SOP tindakan apabila terjadi keracunan makanan", displayNo: 'a.10', group: '9_doc' },
            { no: '9.b', text: "Laporan hasil kalibrasi alat ukur seperti termometer (1 tahun terakhir) tersedia", displayNo: 'b', group: '9_doc' },
            { no: '9.c', text: "Rekaman monitoring suhu chiller dan freezer tersedia", displayNo: 'c', group: '9_doc' },
            { no: '9.d', text: "Rekaman pembersihan fasilitas (contoh: wastafel, toilet, area kerja) tersedia", displayNo: 'd', group: '9_doc' },
        ];
        
        const AREAS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        const AREA_LEGEND = {
            A: 'Area luar bangunan',
            B: 'Area fasilitas karyawan',
            C: 'Area penerimaan bahan baku',
            D: 'Area penyimpanan',
            E: 'Area pengolahan pangan',
            F: 'Area pengemasan/pemorsian',
            G: 'Area loading produk jadi',
            H: 'Area pencucian peralatan'
        };

        let calculatedMaxTotalScore = 0; 
        const STORAGE_KEY = 'ikl_sppg_autosave_v1';
        const THEME_KEY = 'ikl_sppg_theme_v1';
        const SCORE_BAR_STATE_KEY = 'ikl_sppg_score_bar_state';
        
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

        // Flag to prevent saving while loading from cache
        let isInternalUpdate = false;

        // --- COLLAPSIBLE CRITERIA LOGIC (for both Table and Card view) ---
        function toggleCriteriaGroup(groupNo) {
            const tableRows = document.querySelectorAll(`#inspection-table .criteria-group-${groupNo}`);
            const tableIcon = document.getElementById(`icon-group-table-${groupNo}`);
            const cardDivs = document.querySelectorAll(`#inspection-cards .criteria-group-${groupNo}`);
            const cardIcon = document.getElementById(`icon-group-card-${groupNo}`);
            
            let isHidden = tableRows.length > 0 ? tableRows[0].classList.contains('hidden') : false;

            tableRows.forEach(row => row.classList.toggle('hidden', !isHidden));
            cardDivs.forEach(div => div.classList.toggle('hidden', !isHidden));
            
            if (tableIcon) {
                if (isHidden) { tableIcon.classList.add('rotate-180'); } else { tableIcon.classList.remove('rotate-180'); }
            }
            if (cardIcon) {
                if (isHidden) { cardIcon.classList.add('rotate-180'); } else { cardIcon.classList.remove('rotate-180'); }
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        function calculateMaxPossibleScore() {
            let max = 0;
            CRITERIA.forEach(crit => {
                if (crit.isHeader) return;
                Object.values(crit.areas).forEach(val => {
                    if (val !== 'NA') max += parseInt(val, 10);
                });
            });
            return max;
        }

        function getMaxScore(areaScore) { return areaScore === 'NA' ? 0 : parseInt(areaScore, 10); }

        function handleScoreChange(event) {
            const currentInput = event.target;
            const score = parseInt(currentInput.value, 10);
            const name = currentInput.name;

            document.querySelectorAll(`input[name="${name}"] + .score-label`).forEach(label => {
                label.classList.remove('bg-score-red', 'bg-score-green', 'text-white', 'font-semibold');
                label.classList.add('font-medium'); 
            });
            
            const inputId = currentInput.id;
            document.querySelectorAll(`label[for="${inputId}"]`).forEach(label => {
                if (score > 0) {
                    label.classList.add('bg-score-red', 'text-white', 'font-semibold');
                    label.classList.remove('font-medium');
                } else {
                    label.classList.add('bg-score-green', 'text-white', 'font-semibold'); 
                    label.classList.remove('font-medium');
                }
            });

            calculateScore();
            if (!isInternalUpdate) saveFormData(); 
        }

        function handleSpecialReqChange(event) {
            const currentInput = event.target;
            const value = currentInput.value;
            const name = currentInput.name;

            document.querySelectorAll(`input[name="${name}"][type="radio"] + .special-req-label`).forEach(label => {
                label.classList.remove('bg-score-red', 'bg-score-green', 'text-white', 'font-semibold');
                label.classList.add('font-medium'); 
            });
            
            const inputId = currentInput.id;
            document.querySelectorAll(`label[for="${inputId}"]`).forEach(label => {
                if (value === 'Tidak') {
                    label.classList.add('bg-score-red', 'text-white', 'font-semibold');
                    label.classList.remove('font-medium');
                } else if (value === 'Ya') {
                    label.classList.add('bg-score-green', 'text-white', 'font-semibold'); 
                    label.classList.remove('font-medium');
                }
            });

            if (!isInternalUpdate) saveFormData();
        }
        
        function getRadioOptionsHTML(crit, area, isCard = false) {
            const maxScore = getMaxScore(crit.areas[area]);
            const inputName = `crit-${crit.no}-${area}`;

            if (crit.areas[area] === 'NA') {
                return `<span class="text-xs text-gray-500 dark:text-gray-500 font-medium">NA</span>`;
            }

            const scoreOptions = ['NA'];
            for (let i = 1; i <= maxScore; i++) scoreOptions.push(i);

            const optionsHTML = scoreOptions.map(val => {
                const numericValue = val === 'NA' ? 0 : val;
                const inputId = `${inputName}-${val}`;
                const isChecked = (val === 'NA' || val === 0);
                const compactClasses = isCard ? 'py-0.5 text-xs' : '';

                return `<input type="radio" id="${inputId}" name="${inputName}" value="${numericValue}" class="score-input hidden" ${isChecked ? 'checked' : ''}><label for="${inputId}" class="score-label ${compactClasses}">${val}</label>`;
            }).join('');
            
            return isCard ? `<div class="flex flex-col space-y-0.5">${optionsHTML}</div>` : `<div class="flex flex-col space-y-1">${optionsHTML}</div>`;
        }
        
        function getCardScoresHTML(crit) {
            let html = '';
            AREAS.forEach(area => {
                const maxScore = getMaxScore(crit.areas[area]);
                if (maxScore > 0 || crit.areas[area] === 'NA') { 
                    html += `
                        <div class="flex flex-col space-y-1 text-center flex-grow">
                            <p class="text-xs font-bold text-gray-700 dark:text-gray-300">${area}</p>
                            ${getRadioOptionsHTML(crit, area, true)}
                        </div>
                    `;
                }
            });
            return `<div class="pt-3 pb-2"><div class="flex space-x-0.5 justify-around">${html}</div></div>`;
        }

        // --- RENDERING FUNCTIONS ---
        function renderCriteriaTable() {
            const body = document.getElementById('inspection-body');
            const cardContainer = document.getElementById('inspection-cards');
            body.innerHTML = '';
            cardContainer.innerHTML = '';
            
            CRITERIA.forEach((crit) => {
                const isCollapsibleGroup = ['8', '9', '10', '13', '16', '17', '18', '19', '20', '21', '22', '23'].includes(crit.no);
                let groupClass = ''; 
                
                const tableRow = document.createElement('tr');
                tableRow.className = 'criteria-row border-b hover:bg-kitchen-cream dark:hover:bg-gray-700 transition-colors border-gray-200 dark:border-gray-700';

                if (crit.isHeader) {
                    groupClass = crit.group ? `req-header-group-${crit.group}` : ''; 
                    tableRow.classList.add('bg-kitchen-main/10', 'dark:bg-gray-600', 'criteria-header-row'); 
                    
                    if (isCollapsibleGroup) {
                         tableRow.setAttribute('onclick', `toggleCriteriaGroup('${crit.no}')`);
                         const iconSvg = `<svg id="icon-group-table-${crit.no}" class="w-6 h-6 ml-2 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>`;
                         tableRow.innerHTML = `
                            <td class="px-2 py-3 whitespace-nowrap text-center text-sm font-bold align-middle text-kitchen-dark dark:text-white border-r border-gray-200 dark:border-gray-600">${crit.no}</td>
                            <td colspan="9" class="px-4 py-3 text-sm font-bold text-kitchen-dark dark:text-white align-middle flex items-center justify-between">
                                <span>${crit.text}</span>
                                ${iconSvg}
                            </td>`;
                    } else {
                        tableRow.innerHTML = `
                            <td class="px-2 py-3 whitespace-nowrap text-center text-sm font-bold align-middle text-kitchen-dark dark:text-white border-r border-gray-200 dark:border-gray-600">${crit.no}</td>
                            <td colspan="9" class="px-4 py-3 text-sm font-bold text-kitchen-dark dark:text-white align-middle">${crit.text}</td>`;
                    }
                    body.appendChild(tableRow);
                    
                    const cardHeader = document.createElement('div');
                    cardHeader.className = `p-3 bg-kitchen-main/10 dark:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-600 font-bold mt-4 criteria-header-row`;
                    cardHeader.setAttribute('onclick', `toggleCriteriaGroup('${crit.no}')`);
                    const cardIconSvg = `<svg id="icon-group-card-${crit.no}" class="w-6 h-6 ml-2 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>`;
                    cardHeader.innerHTML = `<div class="flex justify-between items-center"><span class="text-kitchen-dark dark:text-white">${crit.no}. ${crit.text}</span>${isCollapsibleGroup ? cardIconSvg : ''}</div>`;
                    cardContainer.appendChild(cardHeader);
                    
                } else {
                    const displayNo = crit.displayNo || crit.no;
                    const textClass = crit.displayNo ? "pl-8" : "px-4"; 
                    
                    if (crit.group) {
                        tableRow.classList.add(`criteria-group-${crit.group}`, 'criteria-group-item', 'hidden'); 
                    }
                    
                    tableRow.innerHTML += `<td class="px-2 py-3 whitespace-nowrap text-center text-sm font-medium align-middle text-gray-700 dark:text-gray-300">${displayNo}</td><td class="${textClass} py-3 text-sm text-gray-700 dark:text-gray-300 align-middle">${crit.text}</td>`;

                    AREAS.forEach(area => {
                        const cell = document.createElement('td');
                        cell.className = 'px-1 py-1 whitespace-nowrap text-center w-12 align-top'; 
                        cell.innerHTML = getRadioOptionsHTML(crit, area, false);
                        tableRow.appendChild(cell);
                    });
                    body.appendChild(tableRow);
                    
                    const cardItem = document.createElement('div');
                    cardItem.className = `p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 criteria-group-item`;
                    if (crit.group) { cardItem.classList.add(`criteria-group-${crit.group}`, 'hidden'); }
                    
                    cardItem.innerHTML = `
                        <div class="flex items-start mb-3 border-b border-dashed pb-2 dark:border-gray-700">
                            <div class="flex-shrink-0 w-8 text-sm font-bold text-kitchen-dark dark:text-kitchen-main">${displayNo}.</div>
                            <div class="flex-grow text-sm text-gray-700 dark:text-gray-300">${crit.text}</div>
                        </div>
                        ${getCardScoresHTML(crit)}
                    `;
                    cardContainer.appendChild(cardItem);
                }
            });
        }

        function renderSpecialRequirements() {
            const container = document.getElementById('special-requirements');
            container.innerHTML = '';
            SPECIAL_REQUIREMENTS.forEach((req) => {
                const div = document.createElement('div');
                
                if (req.isHeader) {
                    div.className = `flex items-center p-3 bg-kitchen-main/10 dark:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-600 font-bold`;
                    if (req.group) {
                        div.classList.add('cursor-pointer');
                        div.setAttribute('onclick', `toggleSpecialReqGroup('${req.group}')`);
                        const iconSvg = `<svg id="icon-req-group-${req.group}" class="w-6 h-6 ml-2 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" /></svg>`;
                        div.innerHTML = `<div class="w-12 text-sm text-kitchen-dark dark:text-white flex-shrink-0 text-center">${req.no}</div><div class="flex-grow text-sm text-kitchen-dark dark:text-white flex justify-between items-center">${req.text} ${iconSvg}</div>`;
                    } else {
                        div.innerHTML = `<div class="w-12 text-sm text-kitchen-dark dark:text-white flex-shrink-0 text-center">${req.no}</div><div class="flex-grow text-sm text-kitchen-dark dark:text-white">${req.text}</div>`;
                    }
                    container.appendChild(div);
                } else if (req.isSubHeader) {
                    div.className = 'pl-16 pr-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300';
                    if (req.group) { div.classList.add(`req-group-${req.group}`, 'hidden'); }
                    div.innerHTML = `<span>${req.text}</span>`;
                    container.appendChild(div);
                } else {
                    const displayNo = req.displayNo || req.no;
                    const indentClass = (req.no > 8 && req.displayNo && req.displayNo.length > 1) ? "pl-8" : ""; 
                    div.className = `flex flex-col md:flex-row md:items-start p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm`;
                    if (req.group) { div.classList.add(`req-group-${req.group}`, 'hidden'); }
                    
                    div.innerHTML = `
                        <div class="flex items-start w-full md:flex-grow">
                            <div class="flex-shrink-0 w-12 text-sm text-gray-700 dark:text-gray-300 font-bold ${indentClass}">${displayNo}</div>
                            <div class="flex-grow text-sm text-gray-700 dark:text-gray-300">${req.text}</div>
                        </div>
                        <div class="w-full flex-shrink-0 flex justify-end mt-3 border-t border-gray-200 dark:border-gray-700 pt-3 md:w-48 md:mt-0 md:border-t-0 md:pt-0 md:justify-end md:ml-4">
                            <div class="flex space-x-2">
                                <input type="radio" id="req-${req.no}-Ya" name="req-${req.no}" value="Ya" class="special-req-input hidden">
                                <label for="req-${req.no}-Ya" class="special-req-label text-sm">Ya</label>
                                <input type="radio" id="req-${req.no}-Tidak" name="req-${req.no}" value="Tidak" class="special-req-input hidden" checked>
                                <label for="req-${req.no}-Tidak" class="special-req-label text-sm">Tidak</label>
                            </div>
                        </div>`;
                    container.appendChild(div);
                }
            });
            toggleSpecialReqGroup('9_doc', true);
        }

        function calculateScore() {
            const scores = document.querySelectorAll('.score-input:checked');
            let totalScore = 0;
            scores.forEach(input => {
                const value = parseInt(input.value, 10);
                if (!isNaN(value) && value > 0) { totalScore += value; }
            });

            const maxScore = calculateMaxPossibleScore();
            let iklScore = 100;
            if (maxScore > 0) { iklScore = 100 - ((totalScore / maxScore) * 100); }
            iklScore = Math.max(0, Math.min(100, iklScore));

            const iklScoreElement = document.getElementById('final-ikl-score');
            const progressBar = document.getElementById('score-progress-bar');
            const iklStatusElement = document.getElementById('ikl-status');

            let iklStatusText, finalScoreColorClass, progressColorClass, iklStatusColorClass;
            
            if (iklScore >= 80) {
                finalScoreColorClass = 'text-ikl-green';
                progressColorClass = 'bg-score-green';
                iklStatusText = 'MEMENUHI SYARAT';
                iklStatusColorClass = 'text-score-green';
            } else {
                finalScoreColorClass = 'text-ikl-red';
                progressColorClass = 'bg-score-red';
                iklStatusText = 'TIDAK MEMENUHI SYARAT';
                iklStatusColorClass = 'text-score-red';
            }

            iklScoreElement.classList.remove('text-ikl-green', 'text-ikl-red');
            iklScoreElement.classList.add(finalScoreColorClass);
            document.getElementById('total-score-value').textContent = totalScore;
            document.getElementById('max-score-label').textContent = `Maksimum: ${maxScore}`; 
            iklScoreElement.textContent = iklScore.toFixed(2);
            
            iklStatusElement.classList.remove('text-score-green', 'text-score-red');
            iklStatusElement.textContent = iklStatusText;
            iklStatusElement.classList.add(iklStatusColorClass);

            progressBar.style.width = `${iklScore}%`;
            progressBar.classList.remove('bg-score-green', 'bg-score-red');
            progressBar.classList.add(progressColorClass);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('icon-moon').classList.add('hidden');
                document.getElementById('icon-sun').classList.remove('hidden');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
            document.getElementById('icon-moon').classList.toggle('hidden', isDark);
            document.getElementById('icon-sun').classList.toggle('hidden', !isDark);
        }
        
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + "px"; 
                icon.classList.add('rotate-180');
                setTimeout(() => { content.style.maxHeight = 'none'; }, 400);
            } else {
                content.style.maxHeight = content.scrollHeight + "px"; 
                requestAnimationFrame(() => {
                    content.classList.add('collapsed');
                    content.style.maxHeight = '0';
                });
                icon.classList.remove('rotate-180');
            }
        }

        function initSectionState(sectionId) {
            const content = document.getElementById(sectionId);
            if (content.classList.contains('collapsed')) {
                content.style.maxHeight = '0';
            } else {
                content.style.maxHeight = 'none';
            }
        }

        function toggleScoreBar() {
            const content = document.getElementById('score-content');
            const icon = document.getElementById('score-toggle-icon');
            const isHidden = content.classList.contains('hidden');
            if (isHidden) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
                localStorage.setItem(SCORE_BAR_STATE_KEY, 'visible');
                document.body.style.marginBottom = '12rem'; 
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
                localStorage.setItem(SCORE_BAR_STATE_KEY, 'hidden');
                document.body.style.marginBottom = '4rem'; 
            }
        }
        
        function initScoreBarState() {
            const savedState = localStorage.getItem(SCORE_BAR_STATE_KEY);
            if (savedState === 'hidden') {
                document.getElementById('score-content').classList.add('hidden');
                document.getElementById('score-toggle-icon').classList.remove('rotate-180');
                document.body.style.marginBottom = '4rem';
            } else {
                document.body.style.marginBottom = '12rem';
            }
        }
        
        function saveFormData() {
            if (isInternalUpdate) return;
            const formData = { textInputs: {}, radioInputs: {} };
            document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(input => {
                formData.textInputs[input.id] = input.value;
            });
            document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                formData.radioInputs[input.name] = input.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
            
            const statusDiv = document.getElementById('autosave-status');
            statusDiv.textContent = 'Tersimpan otomatis';
            setTimeout(() => { statusDiv.textContent = ''; }, 2000);
        }

        function loadFormData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;
            
            try {
                const formData = JSON.parse(savedData);
                if (formData.textInputs) {
                    for (const [id, value] of Object.entries(formData.textInputs)) {
                        const input = document.getElementById(id);
                        if (input) input.value = value;
                    }
                }
                if (formData.radioInputs) {
                    for (const [name, value] of Object.entries(formData.radioInputs)) {
                        const radios = document.querySelectorAll(`input[name="${name}"]`);
                        radios.forEach(radio => {
                            if (radio.value == value) {
                                radio.checked = true;
                                radio.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                    }
                }
            } catch (e) { console.error("Error loading autosave data", e); }
        }

        function initializeFormState() {
            calculatedMaxTotalScore = calculateMaxPossibleScore(); 
            document.getElementById('max-score-label').textContent = `Maksimum: ${calculatedMaxTotalScore}`;

            // Set all B radios to NA (0)
            document.querySelectorAll('.score-input').forEach(input => {
                if (input.value == "0") {
                    input.checked = true;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            // Set all D radios to Tidak
            document.querySelectorAll('.special-req-input').forEach(input => {
                if (input.value === 'Tidak') {
                    input.checked = true;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            calculateScore();
        }

        function resetForm() {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4">Konfirmasi Reset</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">Apakah Anda yakin ingin mereset semua formulir?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-reset" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Batal</button>
                        <button id="confirm-reset" class="px-4 py-2 text-sm font-medium text-white bg-score-red rounded-lg hover:bg-score-red/90 transition-colors">Reset Data</button>
                    </div>
                </div>`;
            document.body.appendChild(confirmModal);

            document.getElementById('cancel-reset').addEventListener('click', () => document.body.removeChild(confirmModal));
            document.getElementById('confirm-reset').addEventListener('click', () => {
                localStorage.removeItem(STORAGE_KEY);
                isInternalUpdate = true;
                
                // Clear text inputs
                document.querySelectorAll('input:not([type="radio"]), textarea').forEach(i => i.value = '');
                initializeFormState();
                
                isInternalUpdate = false;
                window.scrollTo(0, 0);
                document.body.removeChild(confirmModal);
            });
        }

        function toggleSpecialReqGroup(groupNo, forceHide = false) {
            const groupItems = document.querySelectorAll(`.req-group-${groupNo}`);
            const icon = document.getElementById(`icon-req-group-${groupNo}`);
            let isHidden = groupItems.length > 0 ? groupItems[0].classList.contains('hidden') : true;
            if (forceHide && !isHidden) { isHidden = false; }
            groupItems.forEach(item => item.classList.toggle('hidden', !isHidden));
            if (icon) { if (isHidden) { icon.classList.add('rotate-180'); } else { icon.classList.remove('rotate-180'); } }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); 
            renderCriteriaTable();
            renderSpecialRequirements();
            
            initSectionState('content-a');
            initSectionState('content-b');
            initSectionState('content-d');
            initSectionState('content-e');
            initSectionState('content-f');

            // Attach Listeners first
            document.querySelectorAll('.score-input').forEach(i => i.addEventListener('change', handleScoreChange));
            document.querySelectorAll('.special-req-input').forEach(i => i.addEventListener('change', handleSpecialReqChange));
            document.querySelectorAll('.autosave-input').forEach(i => i.addEventListener('input', saveFormData));
            
            isInternalUpdate = true;
            initializeFormState(); 
            loadFormData(); 
            isInternalUpdate = false;

            initScoreBarState(); 
            
            document.getElementById('get-location-btn').addEventListener('click', getLocation);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('generate-ai-report-btn').addEventListener('click', generateReport);
            document.getElementById('reset-form-btn').addEventListener('click', resetForm);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        });

        async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { return response; }
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        function getLocation() {
            const latInput = document.getElementById('latitude'), lonInput = document.getElementById('longitude'), btn = document.getElementById('get-location-btn');
            btn.disabled = true; btn.textContent = "Memuat...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    latInput.value = pos.coords.latitude.toFixed(6); lonInput.value = pos.coords.longitude.toFixed(6);
                    btn.disabled = false; btn.textContent = "Lokasi Diperoleh";
                    saveFormData();
                }, () => {
                    btn.disabled = false; btn.textContent = "Gagal";
                });
            }
        }

        function exportToPDF() {
            const namaSppg = document.getElementById('nama_sppg').value || 'SPPG';
            const opt = { margin: 0.5, filename: `IKL_${namaSppg}.pdf`, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            const element = document.body.cloneNode(true);
            element.querySelectorAll('.no-print, #fixed-score-bar, #theme-toggle').forEach(el => el.remove());
            html2pdf().set(opt).from(element).save();
        }

        async function generateReport() {
            const outputDiv = document.getElementById('ai-report-output');
            const loadingDiv = document.getElementById('ai-loading');
            outputDiv.textContent = ''; loadingDiv.classList.remove('hidden');
            
            const prompt = `Buat laporan ringkas inspeksi sanitasi SPPG dengan skor ${document.getElementById('final-ikl-score').textContent}. Fokus pada temuan kritis.`;
            try {
                const res = await fetchWithExponentialBackoff(API_URL.replace("?key=", ""), { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                });
                const result = await res.json();
                outputDiv.textContent = result.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal memuat.";
            } catch (e) { outputDiv.textContent = "Terjadi kesalahan."; }
            finally { loadingDiv.classList.add('hidden'); }
        }
    </script>
</body>
</html>
